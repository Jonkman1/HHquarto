{
  "hash": "f72e78a53d3055d27fecb61d4b32ef21",
  "result": {
    "markdown": "---\ntitle: \"Kaart van Zwitserland\"\ndescription: |\n     Dit is een mooie blog van Giulia Ruggeri over kaarten maken met `ggplot2` en `sf`, in dit geval van Zwitserland \nauthor: \"Giulia Ruggeri, bewerking Harrie Jonkman\" \ndate: \"07-21-2021\"\nimage: \"Screenshot.PNG\"\ncategories: [analyse]\n\n---\n\n\n## Kaarten maken\n\nOp Medium verscheen eind 2020 dit duidelijke blog van Giulia Ruggeri [Hier de link](https://medium.com/epfl-extension-school/making-a-map-of-covid-19-incidence-in-switzerland-using-ggplot2-and-sf-e765f8ea0221). Ik wilde weer eens met `ggplot2` en `sf` werken en Giulia's blog vond ik interessant en heb ik vervolgens bewerkt.\n\n\nIn de afgelopen jaren is het maken van mooie kaarten in R vrij eenvoudig geworden, dankzij het `{sf}` pakket.\nIn dit artikel gaan we de ruimtelijke verspreiding van de COVID-19 incidentie van de laatste 14 dagen in Zwitserland visualiseren door een thematische kaart te maken, een *choropleth* kaart zoals dat heet. We maken daarbij gebruik van `{sf}` en `{ggplot2}` als onze belangrijkste hulpmiddelen.\n\n`{sf}`, wat staat voor *simple feature* (eenvoudige eigenschap), is de 'go-to' bibliotheek om om te gaan met ruimtelijke vectoriële gegevens, dat zijn gegevens die geografische geometrieën beschrijven als een reeks van punten, die worden beschreven door hun *lengteg-* en *breedtegraad* coördinaten. Hiermee kunnen geografische vormen worden geïmporteerd, gemanipuleerd en geplot en kunnen we gegevens verwerken in een tabel-achtig formaat, net als een data.frame. Wat een opluchting!\n\nIn deze kleine oefening gebruiken we `{readxl}` om het Excel bestand te importeren en binnen te halen van de [website van het Zwitsers Federaal Bureau van Publieke Gezondheid](https://www.bag.admin.ch/bag/en/home/krankheiten/ausbrueche-epidemien-pandemien/aktuelle-ausbrueche-epidemien/novel-cov/situation-schweiz-und-international.html).\n\n`{rcartocolor}` is de R bibliotheek die mooi uitziende kleurschalen bevat, die zijn ontwikkeld voor cartografie.\nZoals David Letterman zou zeggen, `{tidyverse}`'needs no introduction'. Dit zijn de programma's die we hier binnenhalen.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(rcartocolor)\nlibrary(readxl)\n```\n:::\n\n\nLaten we beginnen met het laden van de gegevens, met `read_excel()`, waarin we de exacte naam van het `blad` dat we willen laden kunnen opgeven, hoeveel regels we mogen `overslaan` en hoeveel regels we in totaal willen `behouden`. \n\nWe hebben een rij per kanton en een rij voor de titel, wat betekent dat we slechts 27 rijen hoeven te behouden (er zijn 26 Zwitserse kantons).\n\nWe schonen ook de kolomnamen een beetje op met `clean_names` uit het `{janitor}` pakket en gebruiken `transmute` om de gewenste kolommen te hernoemen en de andere te laten vallen.\n\n> Tot nu toe, eenvoudige dataimport en manipulatie.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncovid_incidence <- read_excel(\"resources/200325_dati di base_grafica_COVID-19-rapporto.xlsx\", \n    sheet = \"COVID19 casi per cantone\", skip = 6, \n    n_max = 27) %>% \n  janitor::clean_names() %>% \n  transmute(canton = cantone, incidence = incidenza_100_000_6)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nNew names:\n* `Casi confermati` -> `Casi confermati...2`\n* `Incidenza/100 000` -> `Incidenza/100 000...3`\n* `` -> `...4`\n* `Casi confermati` -> `Casi confermati...5`\n* `Incidenza/100 000` -> `Incidenza/100 000...6`\n```\n:::\n\n```{.r .cell-code}\nhead(covid_incidence)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 x 2\n  canton incidence\n  <chr>      <dbl>\n1 AG          45.1\n2 AI          99.1\n3 AR          92.3\n4 BE          73  \n5 BL          33  \n6 BS          47.7\n```\n:::\n:::\n\n\nWij hebben nu een variabele die de kantoncodes bevat en een variabele die de incidentie per 100.000, per kanton, van COVID-19 in de laatste 14 dagen bevat.\n\nWe zijn nu klaar om de **shapefiles** te laden.\n\n> Wacht even, wat zijn de shapefiles?\n\nShapefiles, zijn de bestanden die de geografische vormen bevatten die we willen plotten. We willen de data van de kantons plotten, dus hebben we de Zwitserse kantons nodig, die kunnen worden gedownload van\n[hier] (https://www.bfs.admin.ch/bfs/en/home/services/geostat/swiss-federal-statistics-geodata/administrative-boundaries/generalized-boundaries-local-regional-authorities.html).\n\nShapefiles zijn eigenlijk een set van bestanden, die verschillende geografische informatie bevatten (b.v. info over de projecties). Een van deze bestanden heeft de extensie `.shp` en dit is het bestand dat we gaan laden.\n\n> Let op dat je alle andere bestanden in dezelfde map hebt staan.\n\nNu kunnen we dus 2 shapefiles laden, één die de vormen van de kantongrenzen bevat en één die de vorm van de grote meren van Zwitserland bevat.\n\nLaten we ze eens laden en kijken hoe ze eruit zien.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nswiss_lakes <- st_read(\"resources/g2s15.shp\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `g2s15' from data source \n  `C:\\FilesHarrie\\HHQuarto\\posts\\2021-07-21-kaart-van-zwitserland\\resources\\g2s15.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 22 features and 9 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 500253.8 ymin: 63872.4 xmax: 774495.3 ymax: 297632.2\nProjected CRS: CH1903 / LV03\n```\n:::\n\n```{.r .cell-code}\nswiss_cantons <- st_read(\"resources/G1K09.shp\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `G1K09' from data source \n  `C:\\FilesHarrie\\HHQuarto\\posts\\2021-07-21-kaart-van-zwitserland\\resources\\G1K09.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 26 features and 3 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 485414 ymin: 75286 xmax: 833837 ymax: 295935\nProjected CRS: CH1903 / LV03\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nclass(swiss_cantons)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"sf\"         \"data.frame\"\n```\n:::\n:::\n\n\n\n`swiss_cantons` en `swiss_lakes`, worden opgeslagen als `sf data.frame`s (als dataframe van sf dus), zodat we ze kunnen manipuleren, net zoals we tibbles (of data.frames) kunnen manipuleren. Dit is mogelijk omdat geometrieën worden opgeslagen op een zeer nette manier: als een geneste variabele meestal genaamd `geometry`.\nDit zal je enige *speciale* variabele zijn, de andere (die attributen worden genoemd) zullen gewoon normale variabelen zijn. Bijvoorbeeld, elk kanton heeft zijn naam en code gekoppeld aan de geometrie die het beschrijft.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(swiss_cantons)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 6 features and 3 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 546871 ymin: 130593 xmax: 768722 ymax: 295935\nProjected CRS: CH1903 / LV03\n  KT         NAME KURZ                       geometry\n1 17   St. Gallen   SG MULTIPOLYGON (((738559 1968...\n2 12  Basel-Stadt   BS MULTIPOLYGON (((608728 2681...\n3  7    Nidwalden   NW MULTIPOLYGON (((671030 1822...\n4  2         Bern   BE MULTIPOLYGON (((572954 1936...\n5 14 Schaffhausen   SH MULTIPOLYGON (((684561 2726...\n6 10     Fribourg   FR MULTIPOLYGON (((584435 1976...\n```\n:::\n:::\n\n\n> Het voordeel van `{sf}` te gebruiken als ons hoofdgereedschap om met deze datatypes om te gaan? We kunnen `{ggplot2}` gebruiken om ze te plotten!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot()+\n  geom_sf(data = swiss_cantons)\n```\n\n::: {.cell-output-display}\n![](kaart-van-zwitserland_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nEn, net als met elke `{ggplot2}` grafiek, kunnen we het bouwen van de kaart laag voor laag opbouwen.\nLaten we nu de Zwitserse meren toevoegen bovenop de kantonvormen en `theme_void()` gebruiken om de achtergrond en de as te verwijderen.\nIn deze stap kunnen we ook de kantons transparant maken door het `fill` argument op NA te zetten en een lichte groenblauwe kleur toe te voegen om de meren te vullen.\n`geom_sf()` werkt inderdaad net als elke andere `geom_` functie, geen alarmen en geen verrassingen hier.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot()+\n  geom_sf(data = swiss_cantons, fill = NA) +\n  geom_sf(data = swiss_lakes,  fill = \"#d1eeea\", color = \"#d1eeea\") +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](kaart-van-zwitserland_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\nHoe kunnen we nu elk kanton kleuren naar de grootte van de COVID-19 incidentie per 100'000 mensen?\n\nWe hoeven alleen maar de `covid_incidence` tabel en de `swiss_cantons` tabel samen te voegen, met de kantoncode als verbindingsvariabele.\nHiermee kunnen we de variabele incidentie in kaart brengen naar de `fill` esthetiek en ereen **choropleth** kaart van maken, d.w.z. een thematische kaart.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nswiss_cantons <- swiss_cantons %>% \n  left_join(covid_incidence, c(\"KURZ\" = \"canton\"))\n```\n:::\n\n\nOm onze kaart er mooi te laten uitzien, verdelen wij, in plaats van een numerieke variabele te gebruiken, de incidentie in categorieën. Zo is het voor de gebruiker gemakkelijker te zien in welke categorie elk kanton valt.\n\nDit is een typische praktijk voor choropleth kaarten en het kan op verschillende manieren worden gedaan. In dit geval kiezen we voor een brute kracht aanpak, we doen het handmatig.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nswiss_cantons <- swiss_cantons %>% \n  mutate(incidence_cat = case_when(\n    incidence <= 50 ~ \"0-50\",\n    incidence <= 100 ~ \"51-100\",\n    incidence <= 150 ~ \"101-150\",\n    incidence <= 300 ~ \"251-300\"\n  )) %>% \n  mutate(incidence_cat = factor(incidence_cat, levels = c(\"0-50\", \"51-100\",\"101-150\",\"151-200\",\"251-300\")))\n```\n:::\n\n\nNu kunnen we de kleur toewijzen aan de `incidence_cat` variabele en de eerste choropleth kaart maken.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(swiss_cantons) +\n  geom_sf(aes(fill = incidence_cat), size = 0.3) +\n  scale_fill_carto_d(palette = \"BrwnYl\") +\n  geom_sf(data = swiss_lakes, fill = \"#d1eeea\", color = \"#d1eeea\")+\n  theme_void() +\n  theme(legend.title = element_blank(),\n        legend.position = \"bottom\") \n```\n\n::: {.cell-output-display}\n![](kaart-van-zwitserland_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nEn we hebben onze eerste choropleth kaart, gebouwd met alleen `{sf}` en `{ggplot2}`.\nLaten we nog wat puntjes op de i zetten: we zijn niet tevreden met hoe de legende eruit ziet en we kunnen die veranderen met `guide_legend()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(swiss_cantons) +\n  geom_sf(aes(fill = incidence_cat), size = 0.3) +\n  scale_fill_carto_d(palette = \"BrwnYl\",\n                     guide = guide_legend(direction = \"horizontal\",\n            keyheight = unit(2, units = \"mm\"),\n            keywidth = unit(70 / 5, units = \"mm\"),\n            title.position = 'top',\n            title.hjust = 0.5,\n            label.hjust = 0.5,\n            nrow = 1,\n            byrow = T,\n            label.position = \"bottom\")) +\n  geom_sf(data = swiss_lakes, fill = \"#d1eeea\", color = \"#d1eeea\")+\n  theme_void() +\n  theme(legend.title = element_blank(),\n        legend.position = \"bottom\") \n```\n\n::: {.cell-output-display}\n![](kaart-van-zwitserland_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\nNu kunnen we een titel, een ondertitel en labels toevoegen aan de bovenkant van elke kanton.\nWe zullen `{ggrepel}` gebruiken om ervoor te zorgen dat de labels elkaar niet overlappen, we zullen ook `{ggtext}` gebruiken zodat we markdown syntax kunnen gebruiken voor onze titel en ondertitel.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(swiss_cantons) +\n  geom_sf(aes(fill = incidence_cat), size = 0.3) +\n  scale_fill_carto_d(palette = \"BrwnYl\",\n                     guide = guide_legend(direction = \"horizontal\",\n            keyheight = unit(2, units = \"mm\"),\n            keywidth = unit(70 / 5, units = \"mm\"),\n            title.position = 'top',\n            title.hjust = 0.5,\n            label.hjust = 0.5,\n            nrow = 1,\n            byrow = T,\n            label.position = \"bottom\")) +\n  geom_sf(data = swiss_lakes, fill = \"#d1eeea\", color = \"#d1eeea\")+\n  ggrepel::geom_label_repel(\n    data = swiss_cantons,\n    aes(label = paste0(KURZ,\":\",round(incidence, digits = 0)), \n        geometry = geometry),\n    stat = \"sf_coordinates\",\n    min.segment.length = 0.2,\n    colour = \"#541f3f\",\n    size = 3,\n    segment.alpha = 0.5\n  ) +\n  labs(title = \"<b style='color:#541f3f'> COVID-19 gevallen per kanton, laatste 14 dagen </b>\",\n       subtitle = \"<span style='font-size:10pt'>Incidentie per 100'000 inwoners,per canton </span>\",\n       caption = \"Bron: OFSP | updated 12.10.2020\") +\n  theme_void() +\n  theme(legend.title = element_blank(),\n        legend.position = \"bottom\",\n        plot.title = ggtext::element_markdown(),\n        plot.subtitle = ggtext::element_markdown()) \n```\n\n::: {.cell-output-display}\n![](kaart-van-zwitserland_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nWe hebben nu de code om een choropleth kaart te maken en we hebben gezien hoe we die stap voor stap kunnen bouwen met `{ggplot2}`.\nMet een beetje maatwerk hebben we nu een statische kaart die we in een ander formaat opslaan en delen.\n\nAls je geïnteresseerd bent in het omgaan met geografische gegevens, is een van de beste vrij beschikbare bronnen het [Geocomputation with R-boek](https://geocompr.robinlovelace.net). De auteurs van het boek maken veel gebruik van verschillende pakketten voor het plotten van thematische kaarten, met name `{tmap}`, dat ook de moeite waard is om te onderzoeken. \nAls u pakketten zoals `{ggtext}` wilt gebruiken om uw plots aan te passen, is `{ggplot2}` de bibliotheek waarop u wilt vertrouwen, vooral als u al gewend bent om ermee te werken.\n\nIk hoop dat je dit artikel met plezier las en blijf op de hoogte van meer voorbeelden over hoe kaarten in R zijn te maken.\n\n\n\n\n\n\n\n\n\n\n",
    "supporting": [
      "kaart-van-zwitserland_files\\figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": null
  }
}